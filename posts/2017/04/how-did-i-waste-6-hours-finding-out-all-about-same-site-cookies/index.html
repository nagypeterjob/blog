<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>How did I waste 6 hours finding out all about Same-Site cookies?</title>
  <meta name="description" content="Finding out about same-site cookies, lax and strict">
  <meta name="roboots" content="index, archive, follow">
  <meta name="googlebot" content="index, follow">
  <meta property="og:title" content="How did I waste 6 hours finding out all about Same-Site cookies?">
  <meta property="og:description" content="Finding out about same-site cookies, lax and strict">
  <meta name="twitter:card" content="summary">
  <meta name="keywords" content="same-site, cookie, lax, strict">
  <meta name="author" content="Peter Hasko-Nagy">
  <meta property="og:site_name" content="prodisup">
  <meta name="twitter:site" content="@prodisup">
  <meta name="twitter:creator" content="@prodisup">
  <meta name="theme-color" content="#ffffff">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-RS0P9VR61J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RS0P9VR61J');
</script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
  <link rel="stylesheet" href="../../../../css/main.css?v=1.0">
  <link rel="icon" type="image/x-icon" href="../../../../icons/favicon.ico">
  <link rel="apple-touch-icon" sizes="120x120" href="../../../../icons/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="../../../../icons/apple-touch-icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="../../../../icons/apple-touch-icon-180x180.png" />
</head>

<body>
    <div class="container-fluid underline head">
      <div class="container header">
        <div class="row">
          <div class="col">
            <div class="logo">
              You know, I'm something of a computer scientist myself
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <div class="disclaimer">
              The opinions expressed on this blog are purely mine
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <ul>
              <li><a href="../../../../">blog</a></li>
              <li><a href="https://github.com/nagypeterjob">github</a></li>
              <li><a href="https://twitter.com/ngy_ptr">twitter</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container article">
        <div class="row">
            <div class="col post">
                <h1>How did I waste 6 hours finding out all about Same-Site cookies?</h1>
                <p class="date">2017-04-08</p>
                <blockquote class="blockquote">Note: This post was <a href="https://medium.com/@PeterNagyJob/how-did-i-waste-6-hours-finding-out-all-about-same-site-cookies-82d75062ede2">originally</a> published on medium.</blockquote>

                <p>Let me share a rather dull story with you about the misery I have suffered last night. I hope after reading this you will know a lot more about CSRF prevention and Same-Site cookies, and you won’t be sentenced for hours of debugging.</p>  

                <p>The story begins with a project I had last year. The project’s backbone was a Hapi.js backend which implemented a PayPal payment flow trough PayPal JS SDK. The idea was to store each PaymentID* in a Cookie for each individual user session so that I can reuse the ID during the payment process and I am able to validate the requests for given resources. This project was a successful one, all milestones were completed, everything worked fine.</p>

                <abbr>*PaymentID is a unique ID generated by PayPal to identify each paying sessions</abbr>
            
                <hr/>
                <p>Last week I started to work on a new project which also implements PayPal payment, so it was obvious to go back to that old project, grab the usable parts and start to code from there. As finished the code responsible for payment I started to test the website, and I was surprised to see that after the Paypal redirection the execution resource dropped me a nice and fat HTTP 401 error code. For those of you who knows nothing about how Paypal SDK works I wrap it up in the next section.</p>

                <h2>How would the payment flow work in my ideal world?</h2>
                <div class="row list">
                    <div class="col-1 num">1</div>
                    <div class="col-11">There a list of products, prices and other meta information in JSON format, that is sent (POST) to a resource (for example http://localhost:8000/pay). The JSON is formatted by the rules given by PayPal in order to be valid. The resource is requested, and the handler creates a Paypal payment object from the JSON. Inside the JSON there is the <strong>return_url</strong> defined, to which the browser redirects after finishing the payment on PayPal’s website.</div>
                </div>
                <div class="row list">
                    <div class="col-1 num">2</div>
                    <div class="col-11">Right after the PayPal object was created, it produces a PaymentID which is stored in a cookie. It serves multiple purposes, the most important is, that it is only allows the payment to execute, if there is a cookie in the client’s computer with the right PaymentID. In other way, when the browser redirects from PayPal’s website, one is able to enter the <strong>/execute</strong> resource only if it has the right cookie.</div>
                </div>
                <div class="row list">
                    <div class="col-1 num">3</div>
                    <div class="col-11">In case the user were authenticated to use the /execute resource, the payment proceeds, finishes and other database activities run. Cool.</div>
                </div>

                <p>The problem was, that I couldn’t get inside this /execute resource despite all efforts. The cookie I used in my project was the <a href="https://github.com/hapijs/hapi-auth-cookie">hapi-auth-cookie</a> plugin. My first take on the problem was, that there were some radical changes in the inner functions of this plugin since last year. Then I checked it, no fundamental changes were mentioned on its github page.</p>

                <p>My second idea was, that the url mapping of /execute resource messed up the authentication somehow. The PayPal puts some query parameters in the return url, so /execute becomes something like this:</p>

                <blockquote class="blockquote">execute?PaymentId=PAY-LDTMNEI&token=EC-5124K&PayerID=4LX3STQ</blockquote>

                <p>So my idea was, that the resource was registered for authentication without the parameters, so adding them messes up the process. I know it is stupid, and I knew very well that this should work, but I couldn’t find any other reason. After a few hours code/documentation/API reading, debugging, refactoring something happened. When the url was stuck in the above quoted state, I accidentally hit enter. Lo and behold, the resource allowed me to enter, the payment finished, the database was saving the logs. I went trough the whole process instantly again, and after the redirection I was stuck once more. But, hitting enter let me proceed further again. A well-placed page reload after the redirection could save the day, but I didn’t like the idea as it would have omit the problem. I turned to Google in order to find some explanation to this phenomenon. That is where I stumbled across CSRF and the world of same-site cookies.</p>
                <hr/>

                <p>SRF a.k.a Cross Site Request Forgery is a method, in which an attacker makes authenticated requests on a website with the help of your valid cookie. The attack is possible due to third party cookies. When you enter a website, your browser sometimes makes request to other websites as well because of Facebook’s like button or other embedded content on the originally visited site. When these requests are made, the cookies stored in your browser belonging to Facebook, etc. will be attached. This way the third party websites can track your internet activity, like Facebook recently.</p>

                <blockquote>Same-site cookies (née “First-Party-Only” (née “First-Party”)) allow servers to mitigate the risk of CSRF and information leakage attacks by asserting that a particular cookie should only be sent with requests initiated from the same registrable domain. — Chrome Documentation</blockquote>

                <p>To prevent these tracking actions and malicious attacks, browsers came up with the idea of Same-Site Cookie attribute. With that, developers have the ability to decide upon the cookie’s behaviour. The two possible values for this attribute are <strong>lax</strong> and <strong>strict</strong>.</p>

                <div class="row list">
                    <div class="col-1 num">1</div>
                    <div class="col-11"><strong>Scrict</strong>: When strict is set, the cookie should not be sent with the request initiated by third-party websites.</div>
                </div>
                <div class="row list">
                    <div class="col-1 num">2</div>
                    <div class="col-11"><strong>Lax</strong>: When the attribute is set to lax, the cookie will be sent in addition the GET request initiated by a third-party website. However there is one restriction, the request being made should cause a top-level navigation. Meaning, the browser’s url address bar should change by the navigation action. This restriction rules out iFrame and AJAX requests.</div>
                </div>
                <hr/>

                <p>So how all this adds up? In my recall, the problem was, that by default my cookie was not being sent to PayPal in the first place, so when the browser got redirected to my website right after the payment, Paypal couldn’t provide with the appropriate cookie. (SameSite cookie feature was implemented in Chrome and other browsers in April 2016, that is why my new project didn’t work.)</p>

                <h2>The solution</h2>
<pre>
    <code>
server.auth.strategy('session,'cookie’,{
    password: ‘SECRET',
    cookie: ‘session',
    ttl: 3 * 24 * 60 * 60 * 1000, 
    isSecure: false,
    isSameSite: ‘Lax'
})
    </code>
</pre>
                <p>The solution was adding <strong>isSameSite: ‘Lax’</strong> the the strategy definition.</p>

                <p>I do hope that you will find this article useful, and you won’t run into the same mistakes I did during this project.</p>
                <p>Cheers!</p>
                <p>If you would like to get a more detailed explanation</p>
                <p>
                    <div class="row list">
                        <div class="col-1 num">1</div>
                        <div class="col-11"><a href="https://www.sjoerdlangkemper.nl/2016/04/14/preventing-csrf-with-samesite-cookie-attribute/">https://www.sjoerdlangkemper.nl/2016/04/14/preventing-csrf-with-samesite-cookie-attribute/</a></div>
                    </div>
                    <div class="row list">
                        <div class="col-1 num">2</div>
                        <div class="col-11"><a href="https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/">https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/</a></div>
                    </div>
                </p>

                <hr/>
            </div>
        </div>
    </div>
</body>
</html>